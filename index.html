<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordWander - Every story begins with a word that wanders</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.12/typed.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --secondary: #f59e0b;
            --accent: #ec4899;
            --light: #f8fafc;
            --dark: #1e293b;
            --text-light: #64748b;
            --text-dark: #334155;
            --paper: #fefefe;
            --paper-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --radius: 12px;
            --font-serif: 'Crimson Text', serif;
            --font-sans: 'Inter', sans-serif;
        }

        .dark-mode {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --secondary: #fbbf24;
            --accent: #f472b6;
            --light: #0f172a;
            --dark: #cbd5e1;
            --text-light: #94a3b8;
            --text-dark: #e2e8f0;
            --paper: #1e293b;
            --paper-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--light);
            color: var(--text-dark);
            transition: var(--transition);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Landing Page */
        .landing {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: gradientShift 15s ease infinite;
            background-size: 400% 400%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .floating-words {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .floating-word {
            position: absolute;
            font-family: var(--font-serif);
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            opacity: 0;
        }

        .logo {
            font-family: var(--font-serif);
            font-size: 4rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .tagline {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 3rem;
            max-width: 600px;
            line-height: 1.6;
            z-index: 2;
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: var(--secondary);
            color: var(--dark);
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        /* Workspace */
        .workspace {
            display: none;
            min-height: 100vh;
            padding: 2rem 0;
            background: var(--light);
            position: relative;
        }

        .workspace::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
            z-index: 0;
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            z-index: 1;
            position: relative;
        }

        .workspace-title {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            color: var(--text-dark);
        }

        .workspace-controls {
            display: flex;
            gap: 1rem;
        }

        .control-btn {
            background: var(--paper);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--paper-shadow);
            color: var(--text-dark);
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .chapters-container {
            position: relative;
            z-index: 1;
        }

        .chapter {
            background: var(--paper);
            border-radius: var(--radius);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--paper-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .chapter::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chapter-title {
            font-family: var(--font-serif);
            font-size: 1.8rem;
            color: var(--text-dark);
        }

        .chapter-meta {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .chapter-content {
            font-family: var(--font-serif);
            font-size: 1.3rem;
            line-height: 1.8;
            color: var(--text-dark);
            min-height: 150px;
            outline: none;
            position: relative;
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.3rem;
            background: var(--primary);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .ghost-contributor {
            display: inline;
            color: var(--accent);
            opacity: 0.8;
            position: relative;
        }

        .ghost-contributor::after {
            content: "üëª";
            font-size: 0.9rem;
            margin-left: 5px;
        }

        .writing-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .writing-btn {
            padding: 12px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .writing-btn:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
        }

        .writing-btn.secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .writing-btn.secondary:hover {
            background: rgba(109, 40, 217, 0.1);
        }

        /* Story Timeline */
        .timeline-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--paper);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            z-index: 10;
            overflow-x: auto;
        }

        .timeline {
            display: flex;
            align-items: center;
            padding: 0 2rem;
            position: relative;
            min-width: max-content;
        }

        .timeline-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
            transform: translateY(-50%);
            z-index: 1;
        }

        .timeline-node {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--paper);
            border: 3px solid var(--primary);
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: var(--transition);
            margin: 0 30px;
        }

        .timeline-node.active {
            background: var(--primary);
            transform: scale(1.3);
        }

        .timeline-node:hover {
            transform: scale(1.2);
        }

        .node-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--light);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
            margin-bottom: 10px;
        }

        .timeline-node:hover .node-tooltip {
            opacity: 1;
        }

        /* Export Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--paper);
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text-dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .export-option {
            background: var(--light);
            border: 2px solid transparent;
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .export-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .export-option.active {
            border-color: var(--primary);
            background: rgba(109, 40, 217, 0.1);
        }

        .export-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            font-family: var(--font-serif);
            color: rgba(109, 40, 217, 0.2);
            font-size: 1rem;
            user-select: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.5rem;
            }
            
            .tagline {
                font-size: 1.2rem;
            }
            
            .workspace-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .workspace-controls {
                align-self: flex-end;
            }
            
            .chapter {
                padding: 1.5rem;
            }
            
            .chapter-content {
                font-size: 1.1rem;
            }
            
            .writing-controls {
                flex-direction: column;
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --paper-shadow: 0 0 0 2px var(--primary);
            }
            
            .chapter::before {
                width: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Landing Page -->
    <section class="landing active" id="landing">
        <div class="floating-words" id="floatingWords"></div>
        <div class="container">
            <h1 class="logo">WordWander</h1>
            <p class="tagline">Every story begins with a word that wanders</p>
            <button class="btn" id="startWriting">Start Writing</button>
        </div>
    </section>

    <!-- Writing Workspace -->
    <section class="workspace" id="workspace">
        <div class="particles" id="particles"></div>
        <div class="container">
            <div class="workspace-header">
                <h2 class="workspace-title">Your Story</h2>
                <div class="workspace-controls">
                    <button class="control-btn tooltip" id="themeToggle" aria-label="Toggle dark mode">
                        üåô
                    </button>
                    <button class="control-btn tooltip" id="soundToggle" aria-label="Toggle ambient sound">
                        üîà
                    </button>
                    <button class="control-btn tooltip" id="exportBtn" aria-label="Export story">
                        üì§
                    </button>
                    <button class="control-btn tooltip" id="readAloud" aria-label="Read story aloud">
                        üîä
                    </button>
                </div>
            </div>

            <div class="chapters-container" id="chaptersContainer">
                <!-- Chapters will be added here dynamically -->
            </div>

            <div class="writing-controls">
                <button class="writing-btn" id="addChapter">
                    <span>+</span> Add Next Chapter
                </button>
                <button class="writing-btn secondary" id="inspireMe">
                    <span>üí´</span> Inspire Me
                </button>
            </div>
        </div>
    </section>

    <!-- Story Timeline -->
    <div class="timeline-container">
        <div class="timeline">
            <div class="timeline-line"></div>
            <!-- Timeline nodes will be added here dynamically -->
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Export Your Story</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="export-options">
                <div class="export-option" data-format="text">
                    <div class="export-icon">üìù</div>
                    <div>Text File</div>
                </div>
                <div class="export-option" data-format="pdf">
                    <div class="export-icon">üìÑ</div>
                    <div>PDF Document</div>
                </div>
                <div class="export-option" data-format="json">
                    <div class="export-icon">üîÆ</div>
                    <div>JSON Data</div>
                </div>
                <div class="export-option" data-format="poster">
                    <div class="export-icon">üñºÔ∏è</div>
                    <div>Quote Poster</div>
                </div>
            </div>
            <button class="writing-btn" id="confirmExport" style="width: 100%;">Export</button>
        </div>
    </div>

    <script>
        // WordWander - Immersive Collaborative Writing Platform
        // A self-contained single-file web application

        // Application State
        const state = {
            currentChapter: 0,
            chapters: [],
            isDarkMode: false,
            soundEnabled: false,
            isReading: false,
            ghostContributors: [
                { name: "Mysterious Writer", color: "#ec4899" },
                { name: "Story Weaver", color: "#8b5cf6" },
                { name: "Digital Bard", color: "#f59e0b" }
            ],
            aiPrompts: [
                "The old clock tower chimed midnight, but something was different this time...",
                "She found the key hidden in the book, its metal cold against her fingertips.",
                "The forest seemed to breathe with him, each step synchronized with the rustling leaves.",
                "In the reflection, he saw not himself, but a stranger staring back.",
                "The map was torn, but the X marked a spot that called to her very soul.",
                "Rain tapped a rhythm on the windowpane, a secret code only she understood.",
                "The last page of the diary was blank, except for a single drop of ink.",
                "Stars aligned in a pattern he had seen only in his dreams.",
                "The melody floated from the abandoned house, a song without a singer.",
                "Footprints in the snow led nowhere and everywhere at once."
            ]
        };

        // DOM Elements
        const landing = document.getElementById('landing');
        const workspace = document.getElementById('workspace');
        const floatingWords = document.getElementById('floatingWords');
        const chaptersContainer = document.getElementById('chaptersContainer');
        const particlesContainer = document.getElementById('particles');
        const timeline = document.querySelector('.timeline');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Create floating words on landing page
            createFloatingWords();
            
            // Create background particles
            createParticles();
            
            // Initialize event listeners
            initEventListeners();
            
            // Load any saved story
            loadStory();
            
            // If no saved story, create first chapter
            if (state.chapters.length === 0) {
                createNewChapter();
            }
            
            // Update timeline
            updateTimeline();
            
            // Start ambient animations
            startAmbientAnimations();
        });

        // Create floating words animation
        function createFloatingWords() {
            const words = ['story', 'imagine', 'create', 'dream', 'wander', 'words', 'magic', 'adventure', 'mystery', 'journey'];
            
            for (let i = 0; i < 20; i++) {
                const wordEl = document.createElement('div');
                wordEl.className = 'floating-word';
                wordEl.textContent = words[Math.floor(Math.random() * words.length)];
                
                // Random position
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                wordEl.style.left = `${left}%`;
                wordEl.style.top = `${top}%`;
                
                // Random animation
                const duration = 15 + Math.random() * 20;
                const delay = Math.random() * 5;
                
                gsap.to(wordEl, {
                    duration: duration,
                    x: `+=${(Math.random() - 0.5) * 200}`,
                    y: `+=${(Math.random() - 0.5) * 200}`,
                    rotation: Math.random() * 360,
                    opacity: 0.7,
                    delay: delay,
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut"
                });
                
                floatingWords.appendChild(wordEl);
            }
        }

        // Create background particles
        function createParticles() {
            const symbols = ['‚Ä¢', '¬∑', '‚ñ™', '‚ñ´', '‚ô°', '‚òÜ', '‚úΩ', '‚úß', '‚åò', '‚ùÄ'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                
                // Random position
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                particle.style.left = `${left}%`;
                particle.style.top = `${top}%`;
                
                // Random animation
                const duration = 20 + Math.random() * 30;
                const delay = Math.random() * 10;
                
                gsap.to(particle, {
                    duration: duration,
                    x: `+=${(Math.random() - 0.5) * 100}`,
                    y: `+=${(Math.random() - 0.5) * 100}`,
                    rotation: Math.random() * 360,
                    opacity: 0.3,
                    delay: delay,
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut"
                });
                
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize event listeners
        function initEventListeners() {
            // Start writing button
            document.getElementById('startWriting').addEventListener('click', startWriting);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Sound toggle
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', openExportModal);
            
            // Read aloud
            document.getElementById('readAloud').addEventListener('click', toggleReadAloud);
            
            // Add chapter
            document.getElementById('addChapter').addEventListener('click', createNewChapter);
            
            // Inspire me
            document.getElementById('inspireMe').addEventListener('click', addAIPrompt);
            
            // Export modal
            document.getElementById('closeModal').addEventListener('click', closeExportModal);
            document.getElementById('confirmExport').addEventListener('click', confirmExport);
            
            // Export options
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Auto-save on input
            document.addEventListener('input', autoSave);
        }

        // Start writing - transition to workspace
        function startWriting() {
            // Animate landing page out
            gsap.to(landing, {
                duration: 1,
                opacity: 0,
                onComplete: () => {
                    landing.style.display = 'none';
                    workspace.style.display = 'block';
                    
                    // Animate workspace in
                    gsap.from(workspace, {
                        duration: 1,
                        opacity: 0,
                        y: 50
                    });
                    
                    // Focus on first chapter
                    if (state.chapters.length > 0) {
                        const firstChapter = document.getElementById(`chapter-${state.chapters[0].id}`);
                        if (firstChapter) {
                            const contentEditable = firstChapter.querySelector('.chapter-content');
                            if (contentEditable) contentEditable.focus();
                        }
                    }
                }
            });
        }

        // Create a new chapter
        function createNewChapter() {
            const chapterId = Date.now();
            const chapterNumber = state.chapters.length + 1;
            
            const chapter = {
                id: chapterId,
                title: `Chapter ${chapterNumber}`,
                content: '',
                color: getChapterColor(chapterNumber)
            };
            
            state.chapters.push(chapter);
            state.currentChapter = state.chapters.length - 1;
            
            // Create chapter element
            const chapterEl = document.createElement('div');
            chapterEl.className = 'chapter';
            chapterEl.id = `chapter-${chapterId}`;
            chapterEl.style.borderLeftColor = chapter.color;
            
            chapterEl.innerHTML = `
                <div class="chapter-header">
                    <h3 class="chapter-title" contenteditable="true">${chapter.title}</h3>
                    <div class="chapter-meta">Just now</div>
                </div>
                <div class="chapter-content" contenteditable="true" data-chapter-id="${chapterId}"></div>
            `;
            
            // Add to container with animation
            chaptersContainer.appendChild(chapterEl);
            gsap.from(chapterEl, {
                duration: 0.8,
                y: 50,
                opacity: 0,
                ease: "back.out(1.2)"
            });
            
            // Focus on new chapter content
            const contentEditable = chapterEl.querySelector('.chapter-content');
            if (contentEditable) {
                contentEditable.focus();
                
                // Add typing cursor
                addTypingCursor(contentEditable);
            }
            
            // Update timeline
            updateTimeline();
            
            // Auto-save
            autoSave();
            
            // Simulate ghost contributor after a delay
            setTimeout(() => {
                simulateGhostContributor(chapterId);
            }, 5000);
        }

        // Get color for chapter based on index
        function getChapterColor(index) {
            const colors = [
                '#6d28d9', '#8b5cf6', '#a78bfa', '#c4b5fd',
                '#ec4899', '#f472b6', '#fbbf24', '#f59e0b'
            ];
            return colors[(index - 1) % colors.length];
        }

        // Add typing cursor to content editable
        function addTypingCursor(element) {
            // Remove existing cursor
            const existingCursor = element.querySelector('.typing-cursor');
            if (existingCursor) existingCursor.remove();
            
            // Add new cursor
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);
            
            // Update cursor position on input
            element.addEventListener('input', function() {
                cursor.remove();
                this.appendChild(cursor);
            });
            
            // Update cursor position on click
            element.addEventListener('click', function() {
                cursor.remove();
                this.appendChild(cursor);
            });
        }

        // Simulate a ghost contributor adding text
        function simulateGhostContributor(chapterId) {
            const chapter = state.chapters.find(c => c.id === chapterId);
            if (!chapter) return;
            
            const contributor = state.ghostContributors[Math.floor(Math.random() * state.ghostContributors.length)];
            const prompt = state.aiPrompts[Math.floor(Math.random() * state.aiPrompts.length)];
            
            const chapterEl = document.getElementById(`chapter-${chapterId}`);
            if (!chapterEl) return;
            
            const contentEditable = chapterEl.querySelector('.chapter-content');
            if (!contentEditable) return;
            
            // Add ghost contributor text with animation
            const ghostText = document.createElement('span');
            ghostText.className = 'ghost-contributor';
            ghostText.style.color = contributor.color;
            ghostText.textContent = prompt;
            
            // Add to content
            if (contentEditable.textContent.trim() !== '') {
                contentEditable.innerHTML += ' ';
            }
            contentEditable.appendChild(ghostText);
            
            // Animate in
            gsap.from(ghostText, {
                duration: 1,
                opacity: 0,
                y: 10,
                ease: "power2.out"
            });
            
            // Update chapter content in state
            chapter.content = contentEditable.innerHTML;
            
            // Auto-save
            autoSave();
            
            // Show notification
            showNotification(`${contributor.name} added to your story`);
        }

        // Add AI prompt to current chapter
        function addAIPrompt() {
            if (state.chapters.length === 0) return;
            
            const currentChapter = state.chapters[state.currentChapter];
            const prompt = state.aiPrompts[Math.floor(Math.random() * state.aiPrompts.length)];
            
            const chapterEl = document.getElementById(`chapter-${currentChapter.id}`);
            if (!chapterEl) return;
            
            const contentEditable = chapterEl.querySelector('.chapter-content');
            if (!contentEditable) return;
            
            // Add prompt with typing animation
            const promptText = document.createElement('span');
            promptText.textContent = prompt;
            
            // Add to content
            if (contentEditable.textContent.trim() !== '') {
                contentEditable.innerHTML += ' ';
            }
            contentEditable.appendChild(promptText);
            
            // Animate typing
            gsap.from(promptText, {
                duration: 2,
                opacity: 0,
                ease: "power2.inOut"
            });
            
            // Update chapter content in state
            currentChapter.content = contentEditable.innerHTML;
            
            // Auto-save
            autoSave();
            
            // Show notification
            showNotification('Inspiration added to your story');
        }

        // Update story timeline
        function updateTimeline() {
            // Clear existing nodes
            const existingNodes = document.querySelectorAll('.timeline-node');
            existingNodes.forEach(node => node.remove());
            
            // Add nodes for each chapter
            state.chapters.forEach((chapter, index) => {
                const node = document.createElement('div');
                node.className = `timeline-node ${index === state.currentChapter ? 'active' : ''}`;
                node.dataset.chapterId = chapter.id;
                
                const tooltip = document.createElement('div');
                tooltip.className = 'node-tooltip';
                tooltip.textContent = chapter.title;
                
                node.appendChild(tooltip);
                timeline.appendChild(node);
                
                // Add click event to scroll to chapter
                node.addEventListener('click', function() {
                    scrollToChapter(chapter.id);
                });
            });
        }

        // Scroll to specific chapter
        function scrollToChapter(chapterId) {
            const chapterEl = document.getElementById(`chapter-${chapterId}`);
            if (!chapterEl) return;
            
            // Update current chapter
            const chapterIndex = state.chapters.findIndex(c => c.id === chapterId);
            if (chapterIndex !== -1) {
                state.currentChapter = chapterIndex;
                
                // Update active node in timeline
                document.querySelectorAll('.timeline-node').forEach((node, index) => {
                    if (index === chapterIndex) {
                        node.classList.add('active');
                    } else {
                        node.classList.remove('active');
                    }
                });
            }
            
            // Scroll to chapter with animation
            gsap.to(window, {
                duration: 1,
                scrollTo: {
                    y: chapterEl,
                    offsetY: 100
                },
                ease: "power2.inOut"
            });
            
            // Focus on chapter content
            const contentEditable = chapterEl.querySelector('.chapter-content');
            if (contentEditable) {
                contentEditable.focus();
                addTypingCursor(contentEditable);
            }
        }

        // Toggle dark/light theme
        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            
            if (state.isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeToggle').textContent = 'üåô';
            }
            
            // Save preference
            localStorage.setItem('wordwander-theme', state.isDarkMode ? 'dark' : 'light');
        }

        // Toggle ambient sound
        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            
            if (state.soundEnabled) {
                document.getElementById('soundToggle').textContent = 'üîä';
                playAmbientSound();
                showNotification('Ambient sound enabled');
            } else {
                document.getElementById('soundToggle').textContent = 'üîà';
                stopAmbientSound();
                showNotification('Ambient sound disabled');
            }
        }

        // Play ambient sound (base64 encoded placeholder)
        function playAmbientSound() {
            // In a real implementation, this would play a base64 encoded audio
            console.log('Ambient sound playing');
        }

        // Stop ambient sound
        function stopAmbientSound() {
            console.log('Ambient sound stopped');
        }

        // Toggle read aloud
        function toggleReadAloud() {
            if (state.isReading) {
                stopReadAloud();
            } else {
                startReadAloud();
            }
        }

        // Start reading story aloud
        function startReadAloud() {
            if (state.chapters.length === 0) return;
            
            const fullText = state.chapters.map(chapter => 
                `${chapter.title}. ${chapter.content.replace(/<[^>]*>/g, '')}`
            ).join('. ');
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(fullText);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                utterance.onstart = function() {
                    state.isReading = true;
                    document.getElementById('readAloud').textContent = '‚èπÔ∏è';
                    showNotification('Reading story aloud');
                };
                
                utterance.onend = function() {
                    state.isReading = false;
                    document.getElementById('readAloud').textContent = 'üîä';
                };
                
                speechSynthesis.speak(utterance);
            } else {
                showNotification('Text-to-speech not supported in your browser');
            }
        }

        // Stop reading aloud
        function stopReadAloud() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                state.isReading = false;
                document.getElementById('readAloud').textContent = 'üîä';
                showNotification('Stopped reading');
            }
        }

        // Open export modal
        function openExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
            gsap.from(document.querySelector('.modal-content'), {
                duration: 0.5,
                scale: 0.8,
                opacity: 0,
                ease: "back.out(1.2)"
            });
        }

        // Close export modal
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // Confirm export
        function confirmExport() {
            const selectedOption = document.querySelector('.export-option.active');
            if (!selectedOption) {
                showNotification('Please select an export format');
                return;
            }
            
            const format = selectedOption.dataset.format;
            exportStory(format);
            closeExportModal();
        }

        // Export story in selected format
        function exportStory(format) {
            const fullText = state.chapters.map(chapter => 
                `${chapter.title}\n\n${chapter.content.replace(/<[^>]*>/g, '')}`
            ).join('\n\n');
            
            let blob, filename, mimeType;
            
            switch (format) {
                case 'text':
                    blob = new Blob([fullText], { type: 'text/plain' });
                    filename = 'wordwander-story.txt';
                    break;
                    
                case 'pdf':
                    // In a real implementation, this would generate a PDF
                    blob = new Blob([fullText], { type: 'application/pdf' });
                    filename = 'wordwander-story.pdf';
                    break;
                    
                case 'json':
                    const storyData = {
                        title: 'WordWander Story',
                        chapters: state.chapters,
                        exportedAt: new Date().toISOString()
                    };
                    blob = new Blob([JSON.stringify(storyData, null, 2)], { type: 'application/json' });
                    filename = 'wordwander-story.json';
                    break;
                    
                case 'poster':
                    generatePoster();
                    return;
            }
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Story exported as ${format.toUpperCase()}`);
        }

        // Generate poster from story quote
        function generatePoster() {
            // Get a random line from the story
            let allText = '';
            state.chapters.forEach(chapter => {
                allText += chapter.content.replace(/<[^>]*>/g, '') + ' ';
            });
            
            const sentences = allText.split(/[.!?]+/).filter(s => s.trim().length > 20);
            const randomSentence = sentences.length > 0 ? 
                sentences[Math.floor(Math.random() * sentences.length)].trim() : 
                "Every story begins with a word that wanders";
            
            // Create canvas for poster
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 1000;
            const ctx = canvas.getContext('2d');
            
            // Draw background
            ctx.fillStyle = state.isDarkMode ? '#1e293b' : '#f8fafc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw decorative elements
            ctx.fillStyle = state.isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(109, 40, 217, 0.1)';
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 3 + 1;
                ctx.fillRect(x, y, size, size);
            }
            
            // Draw text
            ctx.fillStyle = state.isDarkMode ? '#e2e8f0' : '#334155';
            ctx.font = 'italic 40px "Crimson Text"';
            ctx.textAlign = 'center';
            
            // Wrap text
            const words = randomSentence.split(' ');
            let line = '';
            const lines = [];
            const maxWidth = canvas.width - 100;
            
            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    lines.push(line);
                    line = words[i] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);
            
            // Draw lines
            const lineHeight = 50;
            const startY = (canvas.height - (lines.length * lineHeight)) / 2;
            
            lines.forEach((line, index) => {
                ctx.fillText(line.trim(), canvas.width / 2, startY + (index * lineHeight));
            });
            
            // Draw footer
            ctx.font = '20px "Inter"';
            ctx.fillStyle = state.isDarkMode ? '#94a3b8' : '#64748b';
            ctx.fillText('Created with WordWander', canvas.width / 2, canvas.height - 50);
            
            // Convert to image and download
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wordwander-poster.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Poster generated and downloaded');
            });
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        createNewChapter();
                        break;
                    case 's':
                        e.preventDefault();
                        autoSave();
                        showNotification('Story saved locally');
                        break;
                }
            }
        }

        // Auto-save story to localStorage
        function autoSave() {
            // Update chapter content from DOM
            state.chapters.forEach(chapter => {
                const chapterEl = document.getElementById(`chapter-${chapter.id}`);
                if (chapterEl) {
                    const titleEl = chapterEl.querySelector('.chapter-title');
                    const contentEl = chapterEl.querySelector('.chapter-content');
                    
                    if (titleEl) chapter.title = titleEl.textContent;
                    if (contentEl) chapter.content = contentEl.innerHTML;
                }
            });
            
            // Save to localStorage
            localStorage.setItem('wordwander-story', JSON.stringify(state.chapters));
        }

        // Load story from localStorage
        function loadStory() {
            const savedStory = localStorage.getItem('wordwander-story');
            if (savedStory) {
                try {
                    state.chapters = JSON.parse(savedStory);
                    
                    // Recreate chapter elements
                    state.chapters.forEach((chapter, index) => {
                        const chapterEl = document.createElement('div');
                        chapterEl.className = 'chapter';
                        chapterEl.id = `chapter-${chapter.id}`;
                        chapterEl.style.borderLeftColor = getChapterColor(index + 1);
                        
                        chapterEl.innerHTML = `
                            <div class="chapter-header">
                                <h3 class="chapter-title" contenteditable="true">${chapter.title}</h3>
                                <div class="chapter-meta">Previously</div>
                            </div>
                            <div class="chapter-content" contenteditable="true" data-chapter-id="${chapter.id}">${chapter.content}</div>
                        `;
                        
                        chaptersContainer.appendChild(chapterEl);
                        
                        // Add typing cursor to focused element
                        const contentEditable = chapterEl.querySelector('.chapter-content');
                        contentEditable.addEventListener('focus', function() {
                            addTypingCursor(this);
                            state.currentChapter = index;
                            updateTimeline();
                        });
                    });
                    
                    if (state.chapters.length > 0) {
                        state.currentChapter = 0;
                    }
                } catch (e) {
                    console.error('Error loading saved story:', e);
                }
            }
            
            // Load theme preference
            const savedTheme = localStorage.getItem('wordwander-theme');
            if (savedTheme === 'dark') {
                state.isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Start ambient animations
        function startAmbientAnimations() {
            // Pulse animation for chapters
            setInterval(() => {
                if (state.chapters.length > 0 && Math.random() > 0.7) {
                    const randomChapter = state.chapters[Math.floor(Math.random() * state.chapters.length)];
                    const chapterEl = document.getElementById(`chapter-${randomChapter.id}`);
                    if (chapterEl) {
                        gsap.to(chapterEl, {
                            duration: 0.5,
                            boxShadow: '0 10px 30px rgba(109, 40, 217, 0.3)',
                            yoyo: true,
                            repeat: 1,
                            ease: "sine.inOut"
                        });
                    }
                }
            }, 5000);
        }
    </script>
</body>
</html>